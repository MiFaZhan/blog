name: Deploy to GitHub Pages
on:
  push:
    branches: [ mi ]  # ç›‘å¬ main åˆ†æ”¯çš„æ¨é€
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # åœ¨ GitHub çš„æœåŠ¡å™¨ä¸Šè¿è¡Œ
    steps:
      # æ­¥éª¤1ï¼šä¸‹è½½ç§æœ‰ä»“åº“çš„ä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
                persist-credentials: true  # å…è®¸åç»­æ­¥éª¤ä½¿ç”¨ GITHUB_TOKEN æ¨é€ä»£ç 

      # æ­¥éª¤2ï¼šå®‰è£… Node.js ç¯å¢ƒ
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20  # éœ€ä¸ä½ çš„ Hexo ç‰ˆæœ¬åŒ¹é…

      # æ­¥éª¤3ï¼šå®‰è£… Hexo ä¾èµ–
      - name: Install Dependencies
        run: npm install

      # æ­¥éª¤4ï¼šç”Ÿæˆè±†ç“£é¡µé¢ï¼ˆæœªé…ç½® builtin: trueï¼‰
      # æ­¥éª¤5ï¼šç”Ÿæˆé™æ€ç½‘é¡µæ–‡ä»¶ï¼ˆHexo ç¼–è¯‘ï¼‰
      - name: Generate Static Files
        run: |
            npx hexo douban
            npm run build

      # æ­¥éª¤6ï¼šæäº¤æ›´æ–°åçš„æºæ–‡ä»¶ï¼ˆåŒ…å« abbrlinkï¼‰åˆ° blog ä»“åº“
      - name: Commit Source Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨é»˜è®¤ token
        run: |
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git add .
            git commit -m "chore: sync abbrlink from generated files" || echo "No changes to commit"
            git push origin mi

      # æ­¥éª¤7ï¼šæ¨é€ç”Ÿæˆçš„ç½‘é¡µåˆ°å…¬å¼€ä»“åº“
      - name: Deploy to Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          deploy_key: ${{ secrets.DEPLOY_KEY }}  # ä½¿ç”¨ä¹‹å‰æ·»åŠ çš„ç§é’¥
          publish_dir: ./public                  # Hexo ç”Ÿæˆçš„æ–‡ä»¶å¤¹
          external_repository: MiFaZhan/MiFaZhan.github.io  # æ”¹ä¸ºä½ çš„å…¬å¼€ä»“åº“å
          publish_branch: blog                   # æ¨é€åˆ°å…¬å¼€ä»“åº“çš„ main åˆ†æ”¯

      - name: Sync back to blog-source
        env:
          SOURCE_REPO_TOKEN: ${{ secrets.PAT }}
        run: |
          # è®¾ç½® git é…ç½®
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # å…‹éš† blog-source ä»“åº“
          git clone https://$SOURCE_REPO_TOKEN@github.com/MiFaZhan/blog-source.git blog-source-tmp
          
          # å¤åˆ¶æ›´æ–°åçš„æ–‡ä»¶
          rsync -av --progress source/ blog-source-tmp/source/ --delete
          
          # æäº¤æ›´æ”¹åˆ° blog-source
          cd blog-source-tmp
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "è‡ªåŠ¨æ›´æ–°: åŒæ­¥ abbrlink å±æ€§"
            git push origin main
            echo "âœ… å·²åŒæ­¥ abbrlink å› blog-source"
          else
            echo "ğŸŸ¢ æ— å˜åŒ–ï¼Œæ— éœ€åŒæ­¥"
          fi
