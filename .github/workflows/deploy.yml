name: Deploy to GitHub Pages
on:
  push:
    branches: [ mi ]  # ç›‘å¬ main åˆ†æ”¯çš„æ¨é€
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # åœ¨ GitHub çš„æœåŠ¡å™¨ä¸Šè¿è¡Œ
    steps:
      # æ­¥éª¤1ï¼šä¸‹è½½ç§æœ‰ä»“åº“çš„ä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
                persist-credentials: true  # å…è®¸åç»­æ­¥éª¤ä½¿ç”¨ GITHUB_TOKEN æ¨é€ä»£ç 

      # æ­¥éª¤2ï¼šå®‰è£… Node.js ç¯å¢ƒ
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20  # éœ€ä¸ä½ çš„ Hexo ç‰ˆæœ¬åŒ¹é…

      # æ­¥éª¤3ï¼šå®‰è£… Hexo ä¾èµ–
      - name: Install Dependencies
        run: npm install

      # æ­¥éª¤4ï¼šç”Ÿæˆè±†ç“£é¡µé¢ï¼ˆæœªé…ç½® builtin: trueï¼‰
      # æ­¥éª¤5ï¼šç”Ÿæˆé™æ€ç½‘é¡µæ–‡ä»¶ï¼ˆHexo ç¼–è¯‘ï¼‰
      - name: Generate Static Files
        run: |
            npx hexo douban
            npm run build

      # æ­¥éª¤6ï¼šæäº¤æ›´æ–°åçš„æºæ–‡ä»¶ï¼ˆåŒ…å« abbrlinkï¼‰åˆ° blog ä»“åº“
      - name: Commit Source Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨é»˜è®¤ token
        run: |
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git add .
            git commit -m "chore: sync abbrlink from generated files" || echo "No changes to commit"
            git push origin mi

      # æ­¥éª¤7ï¼šæ¨é€ç”Ÿæˆçš„ç½‘é¡µåˆ°å…¬å¼€ä»“åº“
      - name: Deploy to Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          deploy_key: ${{ secrets.DEPLOY_KEY }}  # ä½¿ç”¨ä¹‹å‰æ·»åŠ çš„ç§é’¥
          publish_dir: ./public                  # Hexo ç”Ÿæˆçš„æ–‡ä»¶å¤¹
          external_repository: MiFaZhan/MiFaZhan.github.io  # æ”¹ä¸ºä½ çš„å…¬å¼€ä»“åº“å
          publish_branch: blog                   # æ¨é€åˆ°å…¬å¼€ä»“åº“çš„ main åˆ†æ”¯

      - name: Sync back to blog-source
        env:
          SOURCE_REPO_TOKEN: ${{ secrets.PAT }}
        run: |
          # 1. å®‰è£…å¿…è¦å·¥å…·
          sudo apt-get update
          sudo apt-get install -y rsync
          
          # 2. è®¾ç½®å…¨å±€ Git èº«ä»½ï¼ˆå¿…é¡»ï¼‰
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 3. å…‹éš†æºä»“åº“ï¼ˆä½¿ç”¨ä»¤ç‰Œè®¤è¯ï¼‰
          git clone "https://$SOURCE_REPO_TOKEN@github.com/MiFaZhan/blog-source.git" blog-source-sync
          
          # 4. åŒæ­¥æ–‡ä»¶ï¼ˆæ­£ç¡®é¡ºåºï¼‰
          rsync -av --progress --delete source/ blog-source-sync/source/
          
          # 5. è¿›å…¥å…‹éš†çš„ä»“åº“ç›®å½•
          cd blog-source-sync
          
          # 6. æ£€æŸ¥æ›´æ”¹
          if [ -n "$(git status --porcelain)" ]; then
            # 7. æ·»åŠ æ‰€æœ‰æ›´æ”¹
            git add -A
            
            # 8. æäº¤æ›´æ”¹ï¼ˆä½¿ç”¨ [skip ci] é¿å…å¾ªç¯ï¼‰
            git commit -m "è‡ªåŠ¨åŒæ­¥: æ›´æ–° abbrlink å±æ€§ [skip ci]"
            
            # 9. å®‰å…¨æ¨é€
            git push origin main
            echo "âœ… å·²åŒæ­¥ abbrlink å› blog-source"
          else
            echo "ğŸŸ¢ æ— å˜åŒ–ï¼Œæ— éœ€åŒæ­¥"
          fi
