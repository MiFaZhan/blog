name: Deploy
on:
  push:
    branches: [main]
    # 仅当豆瓣相关配置或内容变更时触发
    paths:
      - '_config.yml'
      - 'source/_data/douban/**'
      - '!source/_data/douban/cache/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DOUBAN_CACHE_KEY: ${{ github.sha }}-douban

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # 需要完整提交历史记录

    - name: Detect Config Changes
      id: detect
      run: |
        # 检查最近3次提交中是否有豆瓣配置变更
        CHANGED=$(git diff --name-only HEAD~3 HEAD -- '_config.yml' 'source/_data/douban')
        echo "changed_files=$CHANGED" >> $GITHUB_OUTPUT

    - name: Cache Douban Data
      uses: actions/cache@v3
      id: cache
      with:
        path: |
          ./db.json
          ./source/_data/douban/cache
        key: ${{ runner.os }}-douban-${{ env.DOUBAN_CACHE_KEY }}

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: npm

    - name: Install Dependencies
      run: npm ci --omit=optional

    - name: Conditional Douban Generation
      if: |
        steps.cache.outputs.cache-hit != 'true' ||
        steps.detect.outputs.changed_files != ''
      run: |
        npx hexo douban --force
        # 生成缓存标记
        mkdir -p source/_data/douban/cache
        date +%s > source/_data/douban/cache/timestamp

    - name: Build Site
      run: |
        hexo clean
        hexo generate --bail

    - name: Deploy
      uses: peaceiris/actions-gh-pages@v3   
      with:
          deploy_key: ${{ secrets.DEPLOY_KEY }}  # 使用之前添加的私钥
          publish_dir: ./public                  # Hexo 生成的文件夹
          external_repository: MiFaZhan/MiFaZhan.github.io  # 改为你的公开仓库名
          publish_branch: blog                   # 推送到公开仓库的 main 分支
